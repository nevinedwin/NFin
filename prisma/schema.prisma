// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

// Looking for ways to speed up your queries, or scale easily with your serverless or edge functions?
// Try Prisma Accelerate: https://pris.ly/cli/accelerate-init

generator client {
  provider = "prisma-client-js"
  output   = "../generated/prisma/client"
}

datasource db {
  provider = "postgresql"
}

enum TransactionType {
  EXPENSE
  INCOME
  TRANSFER
  GROUP_SPLIT
  LEND
  BORROW
}

enum AccountType {
  CASH
  BANK
  WALLET
  CREDIT_CARD
  INVESTMENT
  EMERGENCY_FUND
  POST_OFFICE
  GOAL
}

enum CategoryType {
  MAIN
  SUB
}

enum ObligationStatus {
  PENDING
  PARTIAL
  SETTLED
}

enum ReminderStatus {
  PENDING
  SENT
  CANCELLED
}

enum BudgetPeriod {
  MONTHLY
  YEARLY
}

enum GoalStatus {
  ACTIVE
  COMPLETED
  CANCELLED
  PAUSED
}

enum InvestmentType {
  FD
  RD
  MUTUAL_FUND
  STOCK
  US_STOCK
  CRYPTO
  INSURANCE
  PPF
  NPS
  GOLD
}

enum InvestmentStatus {
  ACTIVE
  PAUSED
  CLOSED
}

model User {
  id          String  @id @default(uuid())
  clerkUserId String  @unique
  email       String  @unique
  name        String?
  imageUrl    String?

  transactions Transaction[]
  accounts     Account[]
  categories   Category[]
  contacts     Contact[]
  balances     ContactBalance[]
  budgets      Budget[]
  goals        Goal[]
  investments Investment[]
  insurancePolicies InsurancePolicy[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Contact {
  id String @id @default(uuid())

  name  String
  email String?
  phone String

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  participants TransactionParticipant[]
  balance      ContactBalance?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model ContactBalance {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  contactId String  @unique
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  // +ve = contact owes user
  // -ve = user owes contact
  netAmount Float @default(0)

  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Account {
  id String @id @default(uuid())

  name String
  type AccountType

  balance Float @default(0)

  currency String @default("INR")

  countMeInTotal Boolean @default(true)

  // Credit Card Specific fields
  CreditLimit Float?
  billingDate Int?
  dueDate     Int?

  // Bank Specific fields
  accountNumber String?
  ifscCode      String?
  branch        String?
  atmNumber     String?
  cvv           String?
  expiryDate    String?

  //Relations

  // Goal linking
  goal Goal[]

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  transactionsFrom Transaction[] @relation("TransferFrom")
  transactionsTo   Transaction[] @relation("TransferTo")

  isDeleted Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model Category {
  id String @id @default(uuid())

  name String
  type CategoryType

  isActive Boolean @default(true)
  isDeleted Boolean @default(false)

  //Self Relation(Parent Category)
  parentId String?
  parent   Category?  @relation("CategoryHierarchy", fields: [parentId], references: [id])
  children Category[] @relation("CategoryHierarchy")

  //Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  transactions Transaction[]

  createdAt        DateTime         @default(now())
  updatedAt        DateTime         @updatedAt
  budgetCategories BudgetCategory[]

  @@index([userId])
}

model Transaction {
  id String @id @default(uuid())

  amount      Float
  type        TransactionType
  description String?

  date   DateTime @default(now())
  repeat Boolean  @default(false)

  //Relations
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  accountId String?
  account   Account? @relation("TransferFrom", fields: [accountId], references: [id])

  toAccountId String?
  toAccount   Account? @relation("TransferTo", fields: [toAccountId], references: [id])

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id])

  participants TransactionParticipant[]

  isDeleted Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([accountId])
  @@index([categoryId])
  @@index([type])
  @@index([date])
}

model TransactionParticipant {
  id String @id @default(uuid())

  shareAmount Float
  obligationAmount Float
  paidAmount  Float @default(0)

  status ObligationStatus @default(PENDING)

  settlements Settlement[]
  reminders   Reminder[]

  transactionId String
  transaction   Transaction @relation(fields: [transactionId], references: [id], onDelete: Cascade)

  contactId String
  contact   Contact @relation(fields: [contactId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([transactionId])
  @@index([contactId])
}

// immutable
model Settlement {
  id String @id @default(uuid())

  amount Float
  note   String?

  paidAt DateTime @default(now())

  // relation
  participantId String
  participant   TransactionParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@index([participantId])
}

model Reminder {
  id String @id @default(uuid())

  remindAt DateTime
  message  String?

  status ReminderStatus @default(PENDING)

  // relation
  participantId String
  participant   TransactionParticipant @relation(fields: [participantId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([participantId])
  @@index([status])
}

model Budget {
  id String @id @default(uuid())

  name   String
  period BudgetPeriod @default(MONTHLY)

  startDate DateTime
  endDate   DateTime?

  categories BudgetCategory[]

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model BudgetCategory {
  id String @id @default(uuid())

  allocatedAmount Float
  spendAmount     Float @default(0)

  isActive Boolean @default(true)

  budgetId String
  budget   Budget @relation(fields: [budgetId], references: [id], onDelete: Cascade)

  categoryId String
  category   Category @relation(fields: [categoryId], references: [id], onDelete: Cascade)

  @@unique([budgetId, categoryId])
}

model Goal {
  id String @id @default(uuid())

  name         String
  targetAmount Float
  savedAmount  Float  @default(0)

  targetDate DateTime?

  status GoalStatus @default(ACTIVE)

  accountId String?
  account   Account? @relation(fields: [accountId], references: [id], onDelete: Cascade)

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  contributions GoalContribution[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}

model GoalContribution {
  id String @id @default(uuid())

  amount Float

  goalId String
  goal   Goal   @relation(fields: [goalId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([goalId])
}

model Investment {
  id String @id @default(uuid())

  name String
  type InvestmentType

  status InvestmentStatus @default(ACTIVE)

  investedAmount  Float
  currentValue  Float?

  folioNumber String?
  brokerName String?
  sipDate DateTime?
  sipAmount Float?

  startDate DateTime
  maturityDate  DateTime?

  interestRate  Float

  userId  String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([type])
}

model InsurancePolicy {
  id String @id @default(uuid())

  name String
  premiumAmount Float
  coverageAmount Float

  startDate DateTime
  endDate DateTime?

  userId String
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
}